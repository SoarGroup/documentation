
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../DesignDogma/">
      
      
        <link rel="next" href="../Timers/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.2.8">
    
    
      
        <title>Threads in SML - Soar documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.046329b4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.85d0ee34.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#threads-in-sml" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
        <aside class="md-banner">
          <div class="md-banner__inner md-grid md-typeset">
            
            
  This documentation is still work in progress. The documentation is hosted at <a href="https://soar.eecs.umich.edu">the Soar homepage</a>! 

          </div>
          
        </aside>
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Soar documentation" class="md-header__button md-logo" aria-label="Soar documentation" data-md-component="logo">
      
  <img src="../../Images/soar.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Soar documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Threads in SML
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg>
      </label>
    
  
</form>
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="http://github.com/SoarGroup/Documentation" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    SoarGroup/Documentation
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../.." class="md-tabs__link">
          
  
    
  
  Soar

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../soar_manual/" class="md-tabs__link">
          
  
    
  
  Soar Manual

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../" class="md-tabs__link">
          
  
    
  
  Explanations

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../tutorials/" class="md-tabs__link">
          
  
    
  
  Tutorials

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../how_to/" class="md-tabs__link">
          
  
    
  
  HowTo Guides

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../reference/" class="md-tabs__link">
          
  
    
  
  Reference

        </a>
      </li>
    
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../soar/tags/" class="md-tabs__link">
        
  
    
  
  Tag Index

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Soar documentation" class="md-nav__button md-logo" aria-label="Soar documentation" data-md-component="logo">
      
  <img src="../../Images/soar.png" alt="logo">

    </a>
    Soar documentation
  </label>
  
    <div class="md-nav__source">
      <a href="http://github.com/SoarGroup/Documentation" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    SoarGroup/Documentation
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_1" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../.." class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Soar
  </span>
  

            </a>
            
              <label class="md-nav__link " for="__nav_1">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            Soar
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_1_2" >
        
          <label class="md-nav__link" for="__nav_1_2" id="__nav_1_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Research
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_2">
            <span class="md-nav__icon md-icon"></span>
            Research
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../soar/Publications/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Publications
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../soar/ResearchGroups/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Research Groups
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../soar/OtherAcademicInstitutions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Academic Institutions
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../soar/CommercialSoarOrganizations/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Commercial Soar Organizations
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../soar_manual/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Soar Manual
  </span>
  

            </a>
            
              <label class="md-nav__link " for="__nav_2">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Soar Manual
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../soar_manual/01_Introduction/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../soar_manual/02_TheSoarArchitecture/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    The Soar Architecture
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../soar_manual/03_SyntaxOfSoarPrograms/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Syntax of Soar Programs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../soar_manual/04_ProceduralKnowledgeLearning/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Procedural Knowledge Learning
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../soar_manual/05_ReinforcementLearning/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Reinforcement Learning
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../soar_manual/06_SemanticMemory/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Semantic Memory
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../soar_manual/07_EpisodicMemory/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Episodic Memory
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../soar_manual/08_SpatialVisualSystem/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Spatial Visual System
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../soar_manual/09_SoarUserInterface/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Soar User Interface
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../soar_manual/blocksworld/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Blocksworld
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Explanations
  </span>
  

            </a>
            
              <label class="md-nav__link " for="__nav_3">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Explanations
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../BasicKernelTerminology/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Basic Kernel Terminology
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../DesignDogma/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Design Dogma
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Threads in SML
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Threads in SML
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#what-threads-exist" class="md-nav__link">
    What Threads Exist
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#why-have-multiple-threads-at-all" class="md-nav__link">
    Why Have Multiple Threads At All?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#why-have-a-kernel-thread" class="md-nav__link">
    Why Have a Kernel Thread?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#why-have-an-event-thread" class="md-nav__link">
    Why Have an Event Thread?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#callback-threading-and-blocking-on-run" class="md-nav__link">
    Callback Threading and Blocking on Run
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#locking-and-thread-safety" class="md-nav__link">
    Locking and Thread-Safety
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#best-practices" class="md-nav__link">
    Best Practices
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../Timers/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Timers
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../Waterfall/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Waterfall
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../tutorials/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Tutorials
  </span>
  

            </a>
            
              <label class="md-nav__link " for="__nav_4">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Tutorials
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/IntroSoarDebugger/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Java Soar Debugger Intro
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/SMLQuickStartGuide/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Soar Markup Language
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_4" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../tutorials/soar_tutorial/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Official Soar Tutorials
  </span>
  

            </a>
            
              <label class="md-nav__link " for="__nav_4_4">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_4">
            <span class="md-nav__icon md-icon"></span>
            Official Soar Tutorials
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/soar_tutorial/TankEatersConfigFile/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tank and Eaters Configuration
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../how_to/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    HowTo Guides
  </span>
  

            </a>
            
              <label class="md-nav__link " for="__nav_5">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            HowTo Guides
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../how_to/BuildingSoarRos/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Building Soar and ROS1
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../how_to/CLIParsingCode/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CLI Parsing Code
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../how_to/HowToCompileSmlClients/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to compile SML Clients
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../how_to/IOAndRewardLinks/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    IO and Reward Links
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../how_to/MemoryLeakDebuggingWithVisualStudio/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Memory Leak Debugging with Visual Studio
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../how_to/SMLOutputLinkGuide/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SML Output Link Guide
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../how_to/SoarTechnicalFAQ/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Soar Technical FAQ
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../reference/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Reference
  </span>
  

            </a>
            
              <label class="md-nav__link " for="__nav_6">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6_2" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../reference/cli/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Command Line Interface
  </span>
  

            </a>
            
              <label class="md-nav__link " for="__nav_6_2">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_2">
            <span class="md-nav__icon md-icon"></span>
            Command Line Interface
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/cmd_alias/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    alias
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/cmd_trace/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    trace
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/cmd_help/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    help
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/cmd_sp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    sp
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/cmd_load/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    load
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/cmd_gp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    gp
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/cmd_wm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    wm
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/cmd_rl/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    rl
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/cmd_default_wme_depth/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    default_wme_depth
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/cmd_stop_soar/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    stop_soar
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/cmd_alias/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    alias
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/cmd_echo/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    echo
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/cmd_command_to_file/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    command_to_file
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/cmd_unalias/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    unalias
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/cmd_epmem/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    epmem
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/cmd_clog/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    clog
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/cmd_visualize/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    visualize
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/cmd_preferences/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    preference
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/cmd_excise/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    excise
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/cmd_production/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    production
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/cmd_wma/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    wma
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/cmd_smem/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    smem
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/cmd_chunk/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    chunk
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/cmd_soar/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    soar
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/cmd_run/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    run
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/cmd_svs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    svs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/cmd_explain/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    explain
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/cmd_init_soar/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    init_soar
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/cmd_decide/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    decide
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/cmd_print/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    print
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/cmd_debug/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    debug
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/cmd_stats/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    stats
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/cmd_timers/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    timers
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/cmd_watch/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    watch
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/cmd_save/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    save
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/cmd_max_nil_output_cycles/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    max_nil_output_cycles
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/cmd_file_system/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    file_system
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/cmd_output/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    output
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../soar/tags/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tag Index
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#what-threads-exist" class="md-nav__link">
    What Threads Exist
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#why-have-multiple-threads-at-all" class="md-nav__link">
    Why Have Multiple Threads At All?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#why-have-a-kernel-thread" class="md-nav__link">
    Why Have a Kernel Thread?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#why-have-an-event-thread" class="md-nav__link">
    Why Have an Event Thread?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#callback-threading-and-blocking-on-run" class="md-nav__link">
    Callback Threading and Blocking on Run
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#locking-and-thread-safety" class="md-nav__link">
    Locking and Thread-Safety
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#best-practices" class="md-nav__link">
    Best Practices
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  
  
<nav class="md-tags" >
  
    
    
    
      <a href="../../soar/tags/#sml" class="md-tag">sml</a>
    
  
    
    
    
      <a href="../../soar/tags/#threads" class="md-tag">threads</a>
    
  
</nav>


  
  


<h1 id="threads-in-sml">Threads in SML</h1>
<p>This document is intended to explain how threads are used in Soar 8.6 and later
(this document is being written against 8.6.3). It assumes you already have a
passing familiarity with both Soar and the SML interface language. This is
advanced reading, for those who want to understand everything that's going on
"under the hood".</p>
<h2 id="what-threads-exist">What Threads Exist</h2>
<p>As with all things related to SML, we need to divide up the world into
client-side threading and kernel-side threading. The kernel side threading is
relatively simple. The kernel is either run in the client's thread or in its
own separate thread. This choice is made by the client when it initializes the
Soar kernel by calling either <code>Kernel::CreateKernelInCurrentThread()</code>
or <code>Kernel::CreateKernelInNewThread()</code>. A remote connection
(<code>Kernel::CreateRemoteConnection()</code>) doesn't affect the way the kernel is run,
this is determined by the local client that created the kernel initially. If
the kernel is running in its own thread, I will name this thread the <em>KernelThread</em>.</p>
<p>The client side is potentially more complex. First, the client application may
inherently be multi-threaded, such as a Java GUI app or it may be a simple
single-threaded C++ program (e.g. a command line utility). Second, the calls to
start Soar running (e.g. <code>RunAllAgentsForever</code>) block, so many clients will
choose to execute this call in a separate thread in order to keep the rest of
the application responsive. I'll call this the <em>RunThread</em>, which means the thread
where the run call is initiated. Finally, SML itself starts up (by default) a
thread called the <em>EventThread</em>. This thread is intended to keep the client
responsive without a lot of work by the application developer.</p>
<p>This gives us a picture of the overall set of threads:</p>
<table>
<thead>
<tr>
<th>Runs</th>
<th>in</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>KernelThread</td>
<td>Kernel</td>
<td>Keeps the kernel responsive to external commands (i.e. ones coming in over a socket connection).</td>
</tr>
<tr>
<td>EventThread</td>
<td>Client SML</td>
<td>Used to service incoming events sent by the kernel if Soar is not running (i.e. productions are not firing). This thread is optional but is created by default.</td>
</tr>
<tr>
<td>RunThread</td>
<td>Client</td>
<td>Point that run commands are executed. This thread is created by the client, either explicitly with a new thread or implicitly by calling run from the client's main thread.</td>
</tr>
<tr>
<td>Client Threads</td>
<td>Client</td>
<td>Other threads that the client application may have for its own use. Typical examples are window manager threads in GUI apps.</td>
</tr>
</tbody>
</table>
<h2 id="why-have-multiple-threads-at-all">Why Have Multiple Threads At All?</h2>
<p>As we're about to dive into the complexity of the threading in SML, one obvious
question is why not just have a single thread and make everyone's life easier.
Well, the answer is that would make the SML/ kernel developer's life easier but
at the cost of making the client/ application developer's life harder. Let me
explain why that is more fully.</p>
<h2 id="why-have-a-kernel-thread">Why Have a Kernel Thread?</h2>
<p>With Soar 8.6 a single Soar kernel can have multiple clients connected to it at
once. A common situation is an environment in Java that has a local connection
to the kernel itself. A debugger is connected remotely to the kernel and a
logging application is also remotely connected. Commands can be sent to the
kernel over a socket. The question is, how and when should the kernel check
this socket for new commands?</p>
<p>In the single-threaded model, the kernel is running in the same thread as the
client that created it (in our example, the Java environment). In this case,
the client is required to poll the socket periodically to see if new commands
have arrived. This is exactly what the method <code>Kernel::CheckForIncomingCommands()</code>
does and clients that call <code>CreateKernelInCurrentThread()</code> are required to call
this periodically. But making such periodic calls is often difficult for a
client. In the case of the Java app the user would need to start some sort of
timer and poll across to the kernel whenever it went off. If they fail to
realize that this must be done, then the debugger would fail to function at
all, leading to a lot of "why doesn't the debugger respond" problems. In other
clients, making periodic calls may be really complicated. Simple command line
utilities tend to take the form: get command from the user, do some work, print
some results, get another command. Writing these would be much more challenging
if the client is not allowed to block while getting input from the keyboard.</p>
<p>So the result is that we recommend running the kernel in its own thread in most
cases. That separate thread checks for new commands coming in from either the
socket or the local client. In this model, commands are always run in the
kernel's thread. That means if the local client calls "run" what actually
happens is that command is placed on a message queue and the kernel thread then
pulls the command from that queue and executes it. That's important to
understand if you're trying to debug a problem at the kernel level as the
client's function call just adds a message to a queue and you usually need to
break the execution at the point that the kernel's thread has picked up the
message (e.g. in <code>KernelSML::ProcessCommand()</code>). You won't see the client's
triggering call higher up in the call stack at that point as it's in a
different thread.</p>
<h2 id="why-have-an-event-thread">Why Have an Event Thread?</h2>
<p>When Soar is running, it is constantly generating a stream of events. These
events are posted to each client, allowing the client to know what's going on
during the course of a run. The <em>EventThread</em> exists to help clients remain
responsive to these incoming events. The first thing to understand about Soar
events is that they are <strong>synchronous calls</strong>. That is to say, the kernel blocks
during the call to send each client a message that a particular event has
occurred. The kernel only continues executing once that call completes. It may
not be immediately obvious that events need to be synchronous (indeed early on
we thought they might not be) but in turns out to be useful they must be. For
example, consider an agent that wishes to take some action when a new phase
starts so it registers for the start phase event. If the call is not
synchronous, then by the time the event arrives the kernel may now be at a much
later execution point. This would limit clients to knowing what had happened,
but not doing things at particular times (and this turns out to be 95% of the
actual usage).</p>
<p>So given that event calls are synchronous and the kernel blocks waiting for
them to complete, how do we ensure that clients are responsive?</p>
<ul>
<li>
<p>In the case where the kernel and the client are running in the <strong>same thread</strong>
  there is really no problem. The event call is just a function callback and the
  callback executes in the kernel's thread.</p>
</li>
<li>
<p>When the kernel and client are running in <strong>separate processes</strong> connected
  by a socket, the client needs to check for new messages arriving on the socket.</p>
<ul>
<li>
<p>As with the kernel thread, this could be done by requiring the client to
  periodically poll for new events coming in on the socket (and again this
  mode is supported by having clients call
  <code>Kernel::CheckForIncomingEvents()</code>). But this periodic polling can be
  complicated as explained earlier. In fact, the situation is even worse for
  the client as it needs to be as fast as possible responding to incoming
  events or the entire system's performance will degrade.</p>
</li>
<li>
<p>This is where the <em>EventThread</em> comes in. Its job is to check the socket for
  new events and make the appropriate callback to the client code. This keeps the
  client responsive and most people will never stop to wonder how a callback
  inside one process is being triggered by a kernel running in another process
  without their doing anything.</p>
</li>
</ul>
</li>
</ul>
<p>There is however a wrinkle in this behavior. When a run call is made by a
client (on what we're calling the RunThread) that call blocks. While it is
blocked it is checking for incoming messages and dispatching them, while it
waits for the message to indicate that the run has completed to come through.
This means that when a run is triggered by a client, callbacks will occur on the
RunThread. When that client did not initiate the run (e.g. somebody typed run
in the debugger) or when Soar is not running (e.g. during an init-soar event),
events are handled by the EventThread. <strong>This means that callbacks can be called
on different threads at different times</strong>.</p>
<h2 id="callback-threading-and-blocking-on-run">Callback Threading and Blocking on Run</h2>
<p>Let's discuss that a little more. First of all, having the calls come back on
different threads isn't ideal. It means a client developer could have different
bugs that occur when Soar is run from the client or when Soar is run remotely
because the threading is different. In practice, this hasn't really been an
issue. On a larger front though it suggests maybe the run calls should not in
fact block. If the run calls did not block, the client's life would be easier (they
wouldn't need to create a thread when they started a run) and all callbacks
would come in on the event thread. The fact that run does block is largely an
artifact of how we used to design environments. The main run loop used to look
something like:</p>
<div class="language-Java highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">stopped</span><span class="p">)</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="p">{</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="w">    </span><span class="n">Run</span><span class="o">-</span><span class="n">agents</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">step</span><span class="p">()</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="w">    </span><span class="n">Update</span><span class="o">-</span><span class="n">world</span><span class="p">()</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="p">}</span>
</span></code></pre></div>
<p>With this model we really want the run call to block so that each single step
was a single call (writing this where <code>Run-agents-1-step</code> is non-blocking would
be much harder). But over the development of 8.6 we learned that we really
didn't want this model and instead we now have a model more like this:</p>
<div class="language-Java highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="n">RegisterCallback</span><span class="p">(</span><span class="n">update</span><span class="o">-</span><span class="n">after</span><span class="o">-</span><span class="n">output</span><span class="o">-</span><span class="n">event</span><span class="p">,</span><span class="w"> </span><span class="n">updateWorld</span><span class="p">)</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="n">While</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">stopped</span><span class="p">)</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="p">{</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="w">    </span><span class="n">Run</span><span class="o">-</span><span class="n">agents</span><span class="o">-</span><span class="n">forever</span><span class="p">()</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="p">}</span>
</span></code></pre></div>
<p>This new event driven model means that having <code>run-agents-forever</code> be a
non-blocking call would be a possibility after all. In fact it would
probably simplify matters for the client side developer. However, it's a very
significant adjustment (breaking lots of existing code) and so far <strong>we haven't
actively considered making the <code>run-agents-forver</code> call non-blocking</strong>.</p>
<h2 id="locking-and-thread-safety">Locking and Thread-Safety</h2>
<p>Given that there are these multiple threads in the system you may need to
understand how locking is implemented, to ensure thread safety across the
system. The approach we've taken is to assume that the kernel is itself not
thread-safe at all. E.g., we'll assume it's not safe to remove a production at
the same time a preference is being created as the result of another production
firing. Therefore, the approach is to only allow a single command to execute in
the kernel at a time.</p>
<p>In practical terms, this means even if multiple clients are connected through
remote connections their commands are queued up, together with the commands
that come from the local connection and executed one at a time. The code for
this is in ReceiverThread.cpp. This ensures that the <strong>kernel side only executes
one command at a time</strong>.</p>
<p>We also assume that the messaging code is not necessarily thread safe, so we
have the client block from sending two messages at the same time. This is
achieved with the <code>m_ClientMutex</code> mutex object defined in the Connection class.
This decision has a couple of implications.</p>
<p>First, it allows the EventThread and the RunThread in the client to live in
harmony. A run call will wait for the current event to be processed before it
starts and once the run has begun, this lock forces the EventThread to wait for
the run to complete. As a result, <strong>all events during a run (started by that
client) come back on the RunThread</strong> and <strong>all events outside of a run come back on
the EventThread</strong>.</p>
<p>Second, the presence of a lock on the client makes interruption a bit tricky.
If a client issues a stop command from a different thread than the RunThread, it
will block, waiting for the run to complete. This is not very helpful. The
solution is to have the client issue the stop in an event handler callback, as
that callback will always occur on the RunThread if the client is currently
running Soar. (If you really want to follow the different cases, the callback
might be called by the EventThread but only if the client has not called run,
in which case the stop call will go through because the RunThread will not be
holding the lock or at least not holding it for a long time).</p>
<p>You might wonder, given this model how does the debugger print out state
information during a run (e.g. after every 5 decisions). The answer is that it
does the work in a callback so the print commands execute on the same thread as
the original run command.</p>
<p>So while we do not support multiple commands being executed simultaneously
(where a second command starts up at an arbitrary time during the first
command), we do support multiple commands being executed in a stack (or with
reentrancy) where one command is partially complete (such as a run) and another
command is executed in the middle of the first command. The keys to this are
that the run is paused while this happens (it's in an event handler to be more
precise) and the second command executes at a known time (inside an event
handler) so the state of the system is well defined. We often end up with large
sequences of calls going back and forth inside an initial trigger (init-soar is
famous for this) as one action triggers an event, which triggers another action
and so on. But it's all within a single logical stack of commands, rather than
having multiple simultaneous threads of execution.</p>
<h2 id="best-practices">Best Practices</h2>
<p>From the constraints of the threading model we have arrived at these "best
practices" which will help clients behave well:</p>
<table>
<thead>
<tr>
<th></th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Call <code>RunAllAgentsForever</code> in a new thread</td>
<td>If you don't want your application to block waiting for the run call to complete, you should make that call in a new thread.</td>
</tr>
<tr>
<td>Call stop from an event handler</td>
<td>In order to interrupt a run you need to be on the same thread as the original run call (if your client issues the run). This can be ensured by issuing the stop from an event handler's callback. This is also good advice for any other SML call that you wish to make while the kernel is running (e.g. printing out current state information in the middle of a run).</td>
</tr>
<tr>
<td>Don't make assumptions about the thread an event handler is called on</td>
<td>The event handler may be called from the RunThread or from the EventThread depending on the situation.</td>
</tr>
</tbody>
</table>
<p>If you have any concerns about how to follow these guidelines please take a
look at the sample environments that we include with the distributions. E.g.
search for <code>RunAllAgentsForever</code> and <code>Stop</code> to see examples of those behaviors.</p>





                
              </article>
            </div>
          
          
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../DesignDogma/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Design Dogma" rel="prev">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Design Dogma
              </div>
            </div>
          </a>
        
        
          
          <a href="../Timers/" class="md-footer__link md-footer__link--next" aria-label="Next: Timers" rel="next">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Timers
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      SoarGroup &copy;
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.copy", "navigation.tabs", "navigation.footer", "navigation.top", "navigation.indexes", "navigation.expand", "header.autohide"], "search": "../../assets/javascripts/workers/search.dfff1995.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.dff1b7c8.min.js"></script>
      
        <script src="../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>